FROM node:24-alpine AS node-corepack
RUN corepack enable && corepack prepare pnpm@latest --activate

FROM node-corepack AS builder
WORKDIR /app

ARG GITHUB_REPO
ARG GITHUB_PAT
ENV GITHUB_REPO=$GITHUB_REPO
ENV GITHUB_PAT=$GITHUB_PAT

ENV PNPM_HOME="/pnpm"
ENV PATH="$PNPM_HOME:$PATH"

COPY package.json pnpm-lock.yaml ./
RUN --mount=type=cache,id=pnpm,target=/pnpm/store pnpm install --frozen-lockfile

COPY . .
RUN pnpm run sync
RUN pnpm run build
RUN pnpm prune --production

FROM node:24-alpine AS runtime
WORKDIR /app

COPY --from=builder /app/build build/
COPY --from=builder /app/node_modules node_modules/

COPY package.json .
COPY drizzle.config.ts .
COPY ./src/lib/server/db ./src/lib/server/db
COPY ./src/lib/server/crypto.ts ./src/lib/server/crypto.ts

ENV NODE_ENV=production
CMD ["node", "build"]
